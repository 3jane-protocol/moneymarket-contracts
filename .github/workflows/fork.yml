name: Fork Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  fork-tests:
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'ci/run-fork-tests')
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Log Fork Seed
        run: 'echo "Fork seed: 0x${{ github.event.pull_request.base.sha || github.sha }}"'

      - name: Check RPC configuration
        id: rpc
        shell: bash
        env:
          ETH_RPC_URL: ${{ secrets.ETH_RPC_URL }}
        run: |
          if [ -z "${ETH_RPC_URL:-}" ]; then
            echo "configured=false" >> "$GITHUB_OUTPUT"
            {
              echo "### Fork tests skipped"
              echo "- Reason: \`ETH_RPC_URL\` secret is not configured for this context."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "configured=true" >> "$GITHUB_OUTPUT"

      - name: Run fork suites and classify failures
        if: steps.rpc.outputs.configured == 'true'
        shell: bash
        env:
          ETH_RPC_URL: ${{ secrets.ETH_RPC_URL }}
        run: |
          set -o pipefail
          LOG_FILE=fork-tests.log

          set +e
          yarn -s test:forge:fork 2>&1 | tee "$LOG_FILE"
          FORK_EXIT=${PIPESTATUS[0]}
          yarn -s test:forge:fork:upgrade 2>&1 | tee -a "$LOG_FILE"
          UPGRADE_EXIT=${PIPESTATUS[0]}
          set -e

          if [ "$FORK_EXIT" -eq 0 ] && [ "$UPGRADE_EXIT" -eq 0 ]; then
            {
              echo "### Fork tests passed"
              echo "- \`test:forge:fork\`: pass"
              echo "- \`test:forge:fork:upgrade\`: pass"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          INFRA_PATTERN="(429|rate limit|timed out|timeout|connection reset|connection refused|temporary failure in name resolution|no such host|503 Service Unavailable|504 Gateway Timeout|error sending request for url|dns error|failed to get block for fork|failed to instantiate fork)"
          if grep -Eiq "$INFRA_PATTERN" "$LOG_FILE"; then
            {
              echo "### Fork tests encountered infrastructure failure"
              echo "- Result treated as soft failure (non-blocking)."
              echo "- Please rerun if protocol regressions are suspected."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "### Fork tests failed"
            echo "- Failure classified as test/assertion regression (blocking)."
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1

      - name: Upload fork logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fork-test-logs-${{ github.run_id }}
          path: fork-tests.log
          if-no-files-found: ignore
